# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1

orbs:
    win: circleci/windows@5.1.0
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/jobs-steps/#jobs-overview & https://circleci.com/docs/configuration-reference/#jobs
jobs:
  build-linux:
    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/executor-intro/ & https://circleci.com/docs/configuration-reference/#executor-job
    resource_class: small
    docker:
      - image: cimg/base:current
        
    # Add steps to the job
    # See: https://circleci.com/docs/jobs-steps/#steps-overview & https://circleci.com/docs/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout
      - run:
          name: "Update APT"
          command: "sudo apt update"
      - run:
          name: "Install pip"
          command: "sudo apt install python3-pip" 
      - run:
          name: "Install python dependencies"
          command: "pip install -r requirements.txt pyinstaller"
      - run:
          name: "Build application"
          command: "pyinstaller --onefile main.py"
      - run:
          name: "Install latest ghr"
          command: |
            # Get the latest version of GHR
            $LATEST_VERSION = (Invoke-WebRequest -Uri "https://api.github.com/repos/tcnksm/ghr/releases/latest" | ConvertFrom-Json).tag_name
            # Download the GHR Windows zip
            Invoke-WebRequest -Uri "https://github.com/tcnksm/ghr/releases/download/$LATEST_VERSION/ghr_windows_amd64.zip" -OutFile "ghr_latest.zip"
            # Extract the zip file
            Expand-Archive -Path "ghr_latest.zip" -DestinationPath "C:\ghr"
            # Move ghr to a directory in PATH
            Move-Item -Path "C:\ghr\ghr.exe" -Destination "C:\ghr\ghr.exe"
            $env:PATH += ";C:\ghr"
      - run:
          name: "Release"
          command: "'C:\ghr\ghr.exe' -t $env:GITHUB_TOKEN -u $env:CIRCLE_PROJECT_USERNAME -r $env:CIRCLE_PROJECT_REPONAME $date $distPath"
        
  build-windows:
    executor:
        name: win/default
    steps:
        - checkout
        - run:
            name: "Install python dependencies"
            command: "pip install -r requirements.txt pyinstaller"
        - run:
            name: "Build application"
            command: |
                pyinstaller --onefile main.py
                Get-Location
            

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/workflows/ & https://circleci.com/docs/configuration-reference/#workflows
workflows:
  say-hello-workflow: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build-windows
